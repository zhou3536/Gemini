<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyGemini</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="md.css">
    <script src="highlight.min.js"></script>
    <script src="marked.min.js"></script>
</head>

<body>
    <div class="nav">
        <button class="theme-toggle" id="themeToggle"></button>
        <select id="gemini-v" class="send-btn1">
            <option value="gemini-2.5-flash-lite-preview-06-17">Gemini-2.5-F-Lite</option>
            <option value="gemini-2.5-flash">Gemini-2.5-Flash</option>
            <option value="gemini-2.5-pro">Gemini-2.5-Pro</option>
        </select>
        <div class="btnbox">
            <button class="dhdhbtn" onclick="opendhdh()"></button>
            <button class="hisbtn" id="history-b"></button>
        </div>
    </div>
    <div class="container">
        <ul id="history-list" class="list-1"></ul>
        <ul id="list-dhdh" class="list-1"></ul>
        <main class="chat-area" id="chat-area">
            <div id="chat-window"></div>
            <div class="input-area">
                <div id="file-preview-area" class="file-preview-area"></div>
                <textarea id="prompt-input" placeholder="输入消息..." rows="2"></textarea>
                <input type="file" id="file-input" multiple style="display: none;">
                <div class="send-box">
                    <div class="menu">
                        <button id="new-chat-btn">新建对话</button>
                        <button id="addfile"></button>
                        <button id="Search" class="search" onclick="Sch()">联网搜索</button>
                        <button id="send-btn" class="send-btn"></button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM 元素
            const chatWindow = document.getElementById('chat-window');
            const promptInput = document.getElementById('prompt-input');
            const sendBtn = document.getElementById('send-btn');
            const newChatBtn = document.getElementById('new-chat-btn');
            const historyList = document.getElementById('history-list');
            const chatarea = document.getElementById('chat-area');
            const addFileBtn = document.getElementById('addfile');
            const fileInput = document.getElementById('file-input');
            const filePreviewArea = document.getElementById('file-preview-area');

            let selectedFiles = []; // 用于存储用户选择的文件

            // --- 文件处理 ---
            addFileBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (event) => {
                const files = Array.from(event.target.files);
                const MAX_FILE_SIZE_BYTES = 5 * 1024 * 1024;
                let largeFilesDetected = false;

                files.forEach(file => {
                    if (file.size > MAX_FILE_SIZE_BYTES) {
                        largeFilesDetected = true;
                        console.warn(`文件 "${file.name}" (大小: ${file.size} 字节) 超过了 5MB 的限制，将被忽略。`);
                    } else {
                        // 检查是否已存在同名文件，避免重复添加
                        if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                            selectedFiles.push(file);
                        }
                    }
                });

                if (largeFilesDetected) { alert('请选择小于5MB的文件'); }

                renderFilePreviews();
                fileInput.value = ''; // 清空input，以便可以再次选择同名文件
            });

            function renderFilePreviews() {
                filePreviewArea.innerHTML = '';
                if (selectedFiles.length > 0) {
                    filePreviewArea.style.display = 'block';
                } else {
                    filePreviewArea.style.display = 'none';
                    return;
                }

                selectedFiles.forEach((file, index) => {
                    const preview = document.createElement('div');
                    preview.classList.add('file-preview-item');

                    const fileName = document.createElement('span');
                    fileName.textContent = file.name;
                    preview.appendChild(fileName);

                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = '×';
                    removeBtn.addEventListener('click', () => {
                        selectedFiles.splice(index, 1);
                        renderFilePreviews();
                    });
                    preview.appendChild(removeBtn);
                    filePreviewArea.appendChild(preview);
                });
            }

            // 应用状态
            let currentChatId = null;

            // --- 配置 marked.js 和 highlight.js ---
            if (typeof marked !== 'undefined' && typeof hljs !== 'undefined') {
                marked.setOptions({
                    highlight: function (code, lang) {
                        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                        return hljs.highlight(code, { language }).value;
                    },
                    langPrefix: 'hljs language-',
                    gfm: true,
                    breaks: true
                });
            }

            function renderMessage(sender, text, fileCount = 0, targetDiv = null) {
                const messageDiv = targetDiv || document.createElement('div');
                if (!targetDiv) {
                    messageDiv.classList.add('message', `${sender}-message`);
                }

                if (sender === 'gemini' && typeof marked !== 'undefined') {
                    messageDiv.innerHTML = marked.parse(text);
                } else {
                    const p = document.createElement('p');
                    p.textContent = text;
                    messageDiv.innerHTML = ''; // 清空现有内容
                    messageDiv.appendChild(p);
                }

                if (sender === 'user' && fileCount > 0) {
                    const fileInfo = document.createElement('div');
                    fileInfo.classList.add('file-info');
                    fileInfo.textContent = `+${fileCount} 个文件`;
                    messageDiv.appendChild(fileInfo);
                }

                if (!targetDiv) {
                    chatWindow.appendChild(messageDiv);
                }
                chatWindow.scrollTop = chatWindow.scrollHeight;
                return messageDiv;
            }

            function renderChatHistory(messages) {
                chatWindow.innerHTML = '';
                if (!messages || messages.length === 0) {
                    renderMessage('gemini', 'Hello! 今天有什么可以帮你？');
                    return;
                }
                messages.forEach(msg => {
                    const textPart = msg.parts.find(p => p.text);
                    const text = textPart ? textPart.text : '';
                    const fileCount = msg.parts.length - (textPart ? 1 : 0);
                    renderMessage(msg.role === 'user' ? 'user' : 'gemini', text, fileCount);
                });
            }

            async function fetchAndRenderHistory() {
                try {
                    const response = await fetch('/api/history');
                    const histories = await response.json();
                    historyList.innerHTML = '';
                    const Title = document.createElement('div');
                    const listTitle = document.createElement('h4');
                    listTitle.textContent = '关闭列表';
                    const DelHistory = document.createElement('a');
                    DelHistory.textContent = '管理历史';
                    DelHistory.href = 'del.html';
                    Title.appendChild(listTitle);
                    Title.appendChild(DelHistory);
                    historyList.appendChild(Title);
                    histories.forEach(h => {
                        const li = document.createElement('li');
                        li.textContent = h.title;
                        li.title = h.title;
                        li.dataset.chatId = h.chatId;
                        li.addEventListener('click', () => loadChatHistory(h.chatId));
                        historyList.appendChild(li);
                    });
                } catch (error) {
                    console.error('Error fetching history:', error);
                }
            }

            // 加载指定的聊天记录
            async function loadChatHistory(chatId) {
                if (!chatId) return;
                try {
                    const response = await fetch(`/api/history/${chatId}`);
                    if (!response.ok) {
                        throw new Error(`Chat with ID ${chatId} not found.`);
                    }
                    const messages = await response.json();
                    renderChatHistory(messages);
                    generateUserMessageIndex();
                    currentChatId = chatId;
                    md();
                    localStorage.setItem('currentActiveChatId', chatId);
                } catch (error) {
                    console.error('Error loading chat history:', error);
                    localStorage.removeItem('currentActiveChatId');
                    newChatBtn.click();
                }
            }

            // 发送信息
            async function sendMessage() {
                const prompt = promptInput.value.trim();
                const modelSelect = document.getElementById('gemini-v');
                const selectedModel = modelSelect.value;

                if (!prompt && selectedFiles.length === 0) return;

                sendBtn.disabled = true;
                renderMessage('user', prompt, selectedFiles.length);

                chatWindow.scrollTop = chatWindow.scrollHeight;

                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('model', selectedModel);
                formData.append('searchEnabled', SearchOn);

                if (currentChatId) {
                    formData.append('chatId', currentChatId);
                }

                selectedFiles.forEach(file => {
                    formData.append('files', file);
                });

                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.classList.add('message', 'gemini-message', 'loading');
                chatWindow.appendChild(aiMessageDiv);

                const requestingIndicator = document.createElement('i');
                requestingIndicator.innerText = '发送中...';
                aiMessageDiv.appendChild(requestingIndicator);
                chatWindow.scrollTop = chatWindow.scrollHeight;

                let accumulatedText = '';
                let retryCount = 0;
                const maxRetries = 3;
                let customError = null;

                const attemptRequest = async () => {
                    let reader = null;
                    let response = null;

                    try {
                        response = await fetch('/api/chat', {
                            method: 'POST',
                            body: formData,
                            signal: AbortSignal.timeout(120000)
                        });

                        if (!response.ok) {
                            const errData = await response.json().catch(() => ({}));
                            throw new Error(errData.error || `Network response was not ok, status: ${response.status}`);
                        }

                        reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';
                        let lastActivityTime = Date.now();
                        let isCompleted = false;

                        while (true) {
                            const { value, done } = await reader.read();

                            if (done) {
                                if (!isCompleted) throw new Error('Stream ended unexpectedly');
                                break;
                            }

                            lastActivityTime = Date.now();
                            buffer += decoder.decode(value, { stream: true });
                            const parts = buffer.split('\n\n');
                            buffer = parts.pop();

                            for (const part of parts) {
                                if (part.startsWith('data:')) {
                                    const dataString = part.substring(5).trim();
                                    try {
                                        const data = JSON.parse(dataString);

                                        if (data.error) {
                                            const error = new Error(data.error);
                                            if (data.canRetry === false) {
                                                customError = error;
                                            }
                                            throw error;
                                        }

                                        if (data.status === 'THINKING') {
                                            const thinkingIndicator = document.createElement('i');
                                            thinkingIndicator.innerText = SearchOn ? '正在搜索互联网...' : '正在思考...';
                                            aiMessageDiv.innerHTML = '';
                                            aiMessageDiv.appendChild(thinkingIndicator);
                                            promptInput.value = '';
                                            selectedFiles = [];
                                            renderFilePreviews();
                                            if (!currentChatId && data.chatId) {
                                                currentChatId = data.chatId;
                                                localStorage.setItem('currentActiveChatId', currentChatId);
                                            }
                                            continue;
                                        }

                                        if (data.retry) {
                                            const retryInfo = document.createElement('i');
                                            retryInfo.innerText = `连接中断，正在重试... (${data.attempt}/${data.maxRetries})`;
                                            retryInfo.style.color = '#ff6b6b';
                                            // aiMessageDiv.innerHTML = '';
                                            aiMessageDiv.appendChild(retryInfo);
                                            continue;
                                        }

                                        if (data.completed) {
                                            isCompleted = true;
                                            continue;
                                        }

                                        if (data.warning) {
                                            console.warn('Server warning:', data.warning);
                                            continue;
                                        }

                                        if (data.reply) {
                                            if (accumulatedText === '') {
                                                aiMessageDiv.innerHTML = '';
                                            }
                                            accumulatedText += data.reply;

                                            const messageRect = aiMessageDiv.getBoundingClientRect();
                                            const containerRect = chatWindow.getBoundingClientRect();
                                            const messageAtTop = messageRect.top <= containerRect.top + 150;

                                            //不要删除
                                            // const threshold = 10;
                                            // const isAtBottom = chatWindow.scrollHeight - chatWindow.scrollTop - chatWindow.clientHeight <= threshold;

                                            aiMessageDiv.innerHTML = marked.parse(accumulatedText);

                                            // 滚动
                                            if (!messageAtTop) { chatWindow.scrollTop = chatWindow.scrollHeight; };
                                        }
                                    } catch (parseError) {
                                        console.error('Error parsing stream data:', parseError);
                                    }
                                }
                            }

                            if (Date.now() - lastActivityTime > 30000) {
                                throw new Error('Stream timeout - no data received for 30 seconds');
                            }
                        }

                        if (accumulatedText.trim() === '') {
                            throw new Error('No content received from server');
                        }

                        hljs.highlightAll();
                        fetchAndRenderHistory();
                        md();

                    } catch (error) {
                        console.error(`Request attempt ${retryCount + 1} failed:`, error);

                        if (reader) {
                            try { reader.cancel(); } catch (e) { console.error('Error canceling reader:', e); }
                        }

                        if (customError) {
                            throw customError;
                        }

                        if (retryCount < maxRetries - 1) {
                            retryCount++;
                            const retryDelay = Math.min(1000 * Math.pow(2, retryCount), 5000);
                            const retryInfo = document.createElement('i');
                            retryInfo.innerText = `连接失败，${retryDelay / 1000}秒后重试... (${retryCount}/${maxRetries})`;
                            retryInfo.style.color = '#ff6b6b';
                            // aiMessageDiv.innerHTML = '';
                            aiMessageDiv.appendChild(retryInfo);
                            await new Promise(resolve => setTimeout(resolve, retryDelay));
                            return attemptRequest();
                        } else {
                            throw error;
                        }
                    }
                };

                try {
                    await attemptRequest();
                } catch (error) {
                    console.error('All retry attempts failed or non-retryable error:', error);
                    const errorDiv = document.createElement('div');
                    errorDiv.style.color = '#ff6b6b';
                    const errorText = document.createElement('p');
                    errorText.textContent = `抱歉，出现错误：${error.message || '未知错误'}`;
                    errorText.style.margin = '0 0 10px 0';
                    errorDiv.appendChild(errorText);
                    aiMessageDiv.innerHTML = '';
                    aiMessageDiv.appendChild(errorDiv);
                } finally {
                    aiMessageDiv.classList.remove('loading');
                    sendBtn.disabled = false;
                    generateUserMessageIndex();
                }
            }

            // --- 事件监听 ---
            sendBtn.addEventListener('click', sendMessage);
            chatarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // 新建对话
            newChatBtn.addEventListener('click', () => {
                localStorage.removeItem('currentActiveChatId');
                currentChatId = null;
                chatWindow.innerHTML = '';
                renderChatHistory([]);
                generateUserMessageIndex();
            });

            //对话导航
            function generateUserMessageIndex() {
                const indexList = document.getElementById('list-dhdh');
                const userMessages = document.querySelectorAll('#chat-window .message.user-message');
                indexList.innerHTML = '';
                if (userMessages.length === 0) {
                    const listTitle = document.createElement('h4');
                    listTitle.textContent = '开始对话把！';
                    indexList.appendChild(listTitle);
                    return;
                }
                const listTitle = document.createElement('h4');
                listTitle.textContent = '对话导航';
                indexList.appendChild(listTitle);
                userMessages.forEach((messageDiv, index) => {
                    const messageId = `user-msg-${index}`;
                    messageDiv.id = messageId;
                    let messageText = messageDiv.querySelector('p')?.textContent || messageDiv.textContent;
                    messageText = messageText.trim();
                    if (!messageText) return;
                    const displayText = messageText.length > 25 ? messageText.substring(0, 22) + '...' : messageText;
                    const listItem = document.createElement('li');
                    listItem.textContent = displayText;
                    listItem.title = messageText;
                    listItem.addEventListener('click', (event) => {
                        const targetMessage = document.getElementById(messageId);
                        if (targetMessage) {
                            targetMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    });
                    indexList.appendChild(listItem);
                });
            }

            // --- 初始化
            async function initializeApp() {
                await fetchAndRenderHistory();
                const cachedChatId = localStorage.getItem('currentActiveChatId');
                if (cachedChatId) {
                    await loadChatHistory(cachedChatId);
                } else {
                    renderChatHistory([]);
                    generateUserMessageIndex();
                }
            }

            initializeApp();
        });
    </script>
    <script src="script.js"></script>
</body>

</html>