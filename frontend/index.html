<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyGemini</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="md.css">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<style></style>

<body>
    <div class="nav">
        <select id="gemini-v" class="send-btn1">
            <option value="gemini-2.0-flash">Gemini-2.0-Flash</option>
            <option value="gemini-2.5-flash">Gemini-2.5-Flash</option>
            <option value="gemini-2.5-pro">Gemini-2.5-Pro</option>
        </select>
        <button onclick="opendhdh()">⇄</button>
    </div>
    <div class="container">
        <ul id="history-list" class="list-1" onclick="closelist()"></ul>
        <ul id="list-dhdh" class="list-1"></ul>
        <main class="chat-area" id="chat-area">
            <div id="chat-window"></div>
            <div class="input-area">
                <textarea id="prompt-input" placeholder="输入消息..." rows="2" onclick="closelist()"></textarea>
                <input type="file" id="file-input" hidden>
                <div class="send-box">
                    <div id="file-preview-container"></div>
                    <div class="menu">
                        <button id="history-b" onclick="openlist()">历史记录</button>
                        <button id="new-chat-btn">新建对话</button>
                        <button id="Search" class="search" onclick="Sch()">联网搜索</button>
                        <button id="send-btn" class="send-btn">
                        </button>
                        <label for="file-input" class="send-btn" hidden>文件</label>

                    </div>
                </div>

            </div>
            <!-- <p style="text-align: center;padding-bottom: 3px;font-size: 13px;">内容由Google AI生成</p> -->
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM 元素
            const chatWindow = document.getElementById('chat-window');
            const promptInput = document.getElementById('prompt-input');
            const sendBtn = document.getElementById('send-btn');
            const newChatBtn = document.getElementById('new-chat-btn');
            const historyList = document.getElementById('history-list');
            const fileInput = document.getElementById('file-input');
            const filePreviewContainer = document.getElementById('file-preview-container');
            const chatarea = document.getElementById('chat-area');

            // 应用状态
            let currentChatId = null;
            let currentFile = null;

            // --- 配置 marked.js 和 highlight.js ---
            if (typeof marked !== 'undefined' && typeof hljs !== 'undefined') {
                marked.setOptions({
                    highlight: function (code, lang) {
                        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                        return hljs.highlight(code, { language }).value;
                    },
                    langPrefix: 'hljs language-',
                    gfm: true,
                    breaks: true
                });
            }

            function renderMessage(sender, text, targetDiv = null) {
                const messageDiv = targetDiv || document.createElement('div');
                if (!targetDiv) {
                    messageDiv.classList.add('message', `${sender}-message`);
                }
                if (sender === 'gemini' && typeof marked !== 'undefined') {
                    messageDiv.innerHTML = marked.parse(text);
                } else {
                    const p = document.createElement('p');
                    p.textContent = text;
                    messageDiv.innerHTML = '';
                    messageDiv.appendChild(p);
                }
                if (!targetDiv) {
                    chatWindow.appendChild(messageDiv);
                }
                chatWindow.scrollTop = chatWindow.scrollHeight;
                return messageDiv;
            }

            function renderChatHistory(messages) {
                chatWindow.innerHTML = '';
                if (!messages || messages.length === 0) {
                    renderMessage('gemini', 'Hello! 今天有什么可以帮你？');
                    return;
                }
                messages.forEach(msg => {
                    const text = msg.parts.find(p => p.text)?.text || '';
                    renderMessage(msg.role === 'user' ? 'user' : 'gemini', text);
                });
            }

            async function fetchAndRenderHistory() {
                try {
                    const response = await fetch('/api/history');
                    const histories = await response.json();
                    historyList.innerHTML = '';
                    const listTitle = document.createElement('h4');
                    listTitle.textContent = '关闭列表';
                    historyList.appendChild(listTitle);
                    histories.forEach(h => {
                        const li = document.createElement('li');
                        li.textContent = h.title;
                        li.title = h.title;
                        li.dataset.chatId = h.chatId;
                        li.addEventListener('click', () => loadChatHistory(h.chatId));
                        historyList.appendChild(li);
                    });
                } catch (error) {
                    console.error('Error fetching history:', error);
                }
            }

            // 加载指定的聊天记录
            async function loadChatHistory(chatId) {
                if (!chatId) return;
                try {
                    const response = await fetch(`/api/history/${chatId}`);
                    // 如果因为缓存的ID在服务端已被删除而找不到，则应回退到新会话
                    if (!response.ok) {
                        throw new Error(`Chat with ID ${chatId} not found.`);
                    }
                    const messages = await response.json();
                    renderChatHistory(messages);
                    generateUserMessageIndex();
                    currentChatId = chatId;
                    // 加载成功后
                    copycode();
                    localStorage.setItem('currentActiveChatId', chatId);
                } catch (error) {
                    console.error('Error loading chat history:', error);
                    // **关键修改：如果加载失败（比如ID不存在了），清除缓存并打开新会话**
                    localStorage.removeItem('currentActiveChatId');
                    newChatBtn.click(); // 模拟点击新建对话按钮，重置界面
                }
            }
            //发送信息
            async function sendMessage() {
                const prompt = promptInput.value.trim();
                const modelSelect = document.getElementById('gemini-v');
                const selectedModel = modelSelect.value;
                if (!prompt && !currentFile) return;

                sendBtn.disabled = true;
                renderMessage('user', prompt || `已发送文件: ${currentFile.name}`);
                promptInput.value = '';
                filePreviewContainer.innerHTML = '';
                chatWindow.scrollTop = chatWindow.scrollHeight;

                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('model', selectedModel);
                formData.append('searchEnabled', SearchOn);
                if (currentChatId) {
                    formData.append('chatId', currentChatId);
                }
                if (currentFile) {
                    formData.append('file', currentFile);
                    currentFile = null;
                }

                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.classList.add('message', 'gemini-message', 'loading');
                chatWindow.appendChild(aiMessageDiv);

                const think = document.createElement('i');
                think.innerText = '正在思考...';
                const search = document.createElement('i');
                search.innerText = '正在搜索互联网...';
                if (SearchOn) {
                    aiMessageDiv.appendChild(search);
                } else {
                    aiMessageDiv.appendChild(think);
                }

                chatWindow.scrollTop = chatWindow.scrollHeight;

                let accumulatedText = '';
                let retryCount = 0;
                const maxRetries = 3;

                const attemptRequest = async () => {
                    let reader = null;
                    let response = null;

                    try {
                        response = await fetch('/api/chat', {
                            method: 'POST',
                            body: formData,
                            signal: AbortSignal.timeout(120000) // 2分钟超时
                        });

                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(errData.error || 'Network response was not ok');
                        }

                        reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';
                        let lastActivityTime = Date.now();
                        let isCompleted = false;

                        while (true) {
                            const { value, done } = await reader.read();

                            if (done) {
                                if (!isCompleted) {
                                    console.log('Stream ended unexpectedly');
                                    throw new Error('Stream ended unexpectedly');
                                }
                                break;
                            }

                            lastActivityTime = Date.now();
                            buffer += decoder.decode(value, { stream: true });
                            const parts = buffer.split('\n\n');
                            buffer = parts.pop();

                            for (const part of parts) {
                                if (part.startsWith('data:')) {
                                    const dataString = part.substring(5).trim();
                                    try {
                                        const data = JSON.parse(dataString);

                                        if (data.error) {
                                            throw new Error(data.error);
                                        }

                                        // 处理重试通知
                                        if (data.retry) {
                                            const retryInfo = document.createElement('i');
                                            retryInfo.innerText = `连接中断，正在重试... (${data.attempt}/${data.maxRetries})`;
                                            retryInfo.style.color = '#ff6b6b';
                                            aiMessageDiv.innerHTML = '';
                                            aiMessageDiv.appendChild(retryInfo);
                                            continue;
                                        }

                                        // 处理完成信号
                                        if (data.completed) {
                                            isCompleted = true;
                                            console.log(`Response completed. Total length: ${data.totalLength}`);
                                            continue;
                                        }

                                        // 处理警告信息
                                        if (data.warning) {
                                            console.warn('Server warning:', data.warning);
                                            continue;
                                        }

                                        // 处理正常响应
                                        if (data.reply) {
                                            const threshold = 10;
                                            const isAtBottom = chatWindow.scrollHeight - chatWindow.scrollTop - chatWindow.clientHeight <= threshold;

                                            // 更新聊天ID
                                            if (!currentChatId && data.chatId) {
                                                currentChatId = data.chatId;
                                                localStorage.setItem('currentActiveChatId', currentChatId);
                                            }

                                            accumulatedText += data.reply;
                                            aiMessageDiv.innerHTML = marked.parse(accumulatedText);

                                            // 滚动逻辑
                                            const messageRect = aiMessageDiv.getBoundingClientRect();
                                            const containerRect = chatWindow.getBoundingClientRect();
                                            const messageAtTop = messageRect.top <= containerRect.top + 150;

                                            if (isAtBottom && !messageAtTop) {
                                                chatWindow.scrollTop = chatWindow.scrollHeight;
                                            }
                                        }
                                    } catch (parseError) {
                                        console.error('Error parsing stream data:', parseError);
                                        // 继续处理其他数据块，不中断整个流
                                    }
                                }
                            }

                            // 检查是否长时间没有数据
                            if (Date.now() - lastActivityTime > 30000) { // 30秒没有数据
                                throw new Error('Stream timeout - no data received for 30 seconds');
                            }
                        }

                        // 如果到这里没有任何内容，说明可能有问题
                        if (accumulatedText.trim() === '') {
                            throw new Error('No content received from server');
                        }

                        hljs.highlightAll();
                        fetchAndRenderHistory();
                        copycode();
                        return true; // 成功

                    } catch (error) {
                        console.error(`Request attempt ${retryCount + 1} failed:`, error);

                        // 清理资源
                        if (reader) {
                            try {
                                reader.cancel();
                            } catch (e) {
                                console.error('Error canceling reader:', e);
                            }
                        }

                        // 检查是否应该重试
                        if (retryCount < maxRetries - 1 &&
                            !error.message?.includes('quota') &&
                            !error.message?.includes('Authentication')) {

                            retryCount++;
                            const retryDelay = Math.min(1000 * Math.pow(2, retryCount), 5000); // 指数退避，最大5秒

                            const retryInfo = document.createElement('i');
                            retryInfo.innerText = `连接失败，${retryDelay / 1000}秒后重试... (${retryCount}/${maxRetries})`;
                            retryInfo.style.color = '#ff6b6b';
                            aiMessageDiv.innerHTML = '';
                            aiMessageDiv.appendChild(retryInfo);

                            await new Promise(resolve => setTimeout(resolve, retryDelay));
                            return attemptRequest(); // 递归重试
                        } else {
                            throw error; // 重试次数用完或不可重试的错误
                        }
                    }
                };

                try {
                    await attemptRequest();
                } catch (error) {
                    console.error('All retry attempts failed:', error);

                    let errorMessage = '抱歉，出现错误：';
                    if (error.message?.includes('timeout')) {
                        errorMessage += '请求超时，请检查网络连接后重试';
                    } else if (error.message?.includes('quota')) {
                        errorMessage += 'API 配额不足，请稍后重试';
                    } else if (error.message?.includes('Network')) {
                        errorMessage += '网络连接问题，请检查网络后重试';
                    } else if (error.message?.includes('parse stream')) {
                        errorMessage += '数据流解析失败，请重试';
                    } else {
                        errorMessage += error.message || '未知错误';
                    }

                    // 显示错误信息
                    const errorDiv = document.createElement('div');
                    errorDiv.style.color = '#ff6b6b';
                    const errorText = document.createElement('p');
                    errorText.textContent = errorMessage;
                    errorText.style.margin = '0 0 10px 0';
                    errorDiv.appendChild(errorText);
                    aiMessageDiv.innerHTML = '';
                    aiMessageDiv.appendChild(errorDiv);

                } finally {
                    aiMessageDiv.classList.remove('loading');
                    sendBtn.disabled = false;
                    generateUserMessageIndex();

                    const threshold = 10;
                    const isAtBottom = chatWindow.scrollHeight - chatWindow.scrollTop - chatWindow.clientHeight <= threshold;
                    if (isAtBottom) {
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                    }
                }
            }

            // --- 事件监听 ---
            sendBtn.addEventListener('click', sendMessage);
            chatarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // 新建对话
            newChatBtn.addEventListener('click', () => {
                localStorage.removeItem('currentActiveChatId');
                currentChatId = null;
                currentFile = null;
                chatWindow.innerHTML = '';
                filePreviewContainer.innerHTML = '';
                renderChatHistory([]); // 清空并显示欢迎语
                generateUserMessageIndex();
            });

            fileInput.addEventListener('change', (e) => {
                currentFile = e.target.files[0];
                if (currentFile) {
                    filePreviewContainer.innerHTML = `<span>${currentFile.name}</span>`;
                }
            });
            //删除历史
            window.del = del;
            async function del(...indices) {
                try {
                    await fetch('/api/history/delete-by-indices', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json', },
                        body: JSON.stringify({ indices: indices })
                    });
                    fetchAndRenderHistory();
                    newChatBtn.click();
                } catch (error) { console.error("删除请求失败:", error); }
            }
            //对话导航
            function generateUserMessageIndex() {
                const indexList = document.getElementById('list-dhdh');
                const userMessages = document.querySelectorAll('#chat-window .message.user-message');
                indexList.innerHTML = '';
                if (userMessages.length === 0) {
                    return;
                }
                const listTitle = document.createElement('h4');
                listTitle.textContent = '对话导航';
                indexList.appendChild(listTitle);
                userMessages.forEach((messageDiv, index) => {
                    const messageId = `user-msg-${index}`;
                    messageDiv.id = messageId;
                    let messageText = messageDiv.querySelector('p')?.textContent || messageDiv.textContent;
                    messageText = messageText.trim();
                    if (!messageText) return;
                    const displayText = messageText.length > 25 ? messageText.substring(0, 22) + '...' : messageText;
                    const listItem = document.createElement('li');
                    listItem.textContent = displayText;
                    listItem.title = messageText;
                    listItem.addEventListener('click', (event) => {
                        const targetMessage = document.getElementById(messageId);
                        if (targetMessage) {
                            targetMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    });
                    indexList.appendChild(listItem);
                });
            }

            // --- 初始化
            async function initializeApp() {
                // 1. 总是获取并渲染历史列表
                await fetchAndRenderHistory();

                // 2. 检查localStorage中是否有缓存的对话ID
                const cachedChatId = localStorage.getItem('currentActiveChatId');
                if (cachedChatId) {
                    await loadChatHistory(cachedChatId);
                } else {
                    renderChatHistory([]);
                    generateUserMessageIndex();
                }
            }

            initializeApp();
        });
    </script>
    <script src="script.js"></script>
</body>

</html>