<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyGemini</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<style></style>

<body>
    <div class="nav">
        <img src="gmm.jpg" alt="">
        <select id="gemini-v" class="">
            <option value="gemini-2.0-flash">2.0-flash</option>
            <option value="gemini-2.5-flash">2.5-flash</option>
            <option value="gemini-2.5-pro">2.5-pro</option>
        </select>
        <button id="new-chat-btn">新建对话</button>
        <button id="history-b" onclick="openlist()">历史对话</button>
    </div>
    <div class="container" onclick="closelist()">
        <ul id="history-list" class="list-1"></ul>
        <ul id="list-123" class="list-1"></ul>
        <main class="chat-area">
            <div id="chat-window"></div>
            <!-- <div id="loading-indicator" class="hidden"></div> -->
            <div class="input-area">
                <textarea id="prompt-input" placeholder="输入消息..." rows="3"></textarea>
                <input type="file" id="file-input" hidden>
                <div class="send-box">
                    <div id="file-preview-container"></div>
                    <div style="display: grid;gap: 5px;">
                        <button id="send-btn" class="send-btn">
                            <!-- <img src="sent.png" alt=""> -->
                            <!-- <div class="ai-8 hidden" id="loading-indicator"></div> -->
                        </button>
                        <label for="file-input" class="send-btn" hidden>文件</label>

                    </div>
                </div>

            </div>
            <p style="text-align: center;padding-bottom: 3px;font-size: 13px;">内容由Google AI生成</p>
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM 元素
            const chatWindow = document.getElementById('chat-window');
            const promptInput = document.getElementById('prompt-input');
            const sendBtn = document.getElementById('send-btn');
            const newChatBtn = document.getElementById('new-chat-btn');
            const historyList = document.getElementById('history-list');
            // const loadingIndicator = document.getElementById('loading-indicator');
            const fileInput = document.getElementById('file-input');
            const filePreviewContainer = document.getElementById('file-preview-container');

            // 应用状态
            let currentChatId = null;
            let currentFile = null;

            // --- 配置 marked.js 和 highlight.js ---
            if (typeof marked !== 'undefined' && typeof hljs !== 'undefined') {
                marked.setOptions({
                    // 这里的 highlight 函数告诉 marked 如何高亮代码
                    highlight: function (code, lang) {
                        // 检查语言是否在 highlight.js 中注册，否则使用纯文本
                        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                        return hljs.highlight(code, { language }).value;
                    },
                    // marked 生成的代码块的类前缀，以便 highlight.js 的 CSS 可以识别
                    langPrefix: 'hljs language-',
                    gfm: true, // 启用 GitHub Flavored Markdown (表格、任务列表等)
                    breaks: true // 允许 Markdown 中的换行符渲染为 <br>
                });
            }


            // --- 功能函数 ---

            // 渲染消息 (现在可以处理Markdown)
            function renderMessage(sender, text, targetDiv = null) {
                const messageDiv = targetDiv || document.createElement('div');
                if (!targetDiv) {
                    messageDiv.classList.add('message', `${sender}-message`);
                }
                if (sender === 'gemini' && typeof marked !== 'undefined') {
                    messageDiv.innerHTML = marked.parse(text);
                } else {
                    const p = document.createElement('p');
                    p.textContent = text;
                    messageDiv.innerHTML = ''; // 清空以防万一
                    messageDiv.appendChild(p);
                }
                if (!targetDiv) {
                    chatWindow.appendChild(messageDiv);
                }
                chatWindow.scrollTop = chatWindow.scrollHeight;
                return messageDiv;
            }

            // 渲染整个消息历史 (保持不变，因为 renderMessage 会处理Markdown)
            function renderChatHistory(messages) {
                chatWindow.innerHTML = '';
                if (!messages || messages.length === 0) {
                    renderMessage('gemini', 'Hello! How can I do for you?'); // 更改了欢迎语末尾的字符，防止误解
                    return;
                }
                messages.forEach(msg => {
                    const text = msg.parts.find(p => p.text)?.text || '';
                    // 确保渲染历史时也正确处理Gemini的Markdown
                    renderMessage(msg.role === 'user' ? 'user' : 'gemini', text);
                });
            }


            // 设置加载状态
            // function setLoading(isLoading) {
            //     sendBtn.disabled = isLoading;
            //     loadingIndicator.classList.toggle('hidden', !isLoading);
            // }

            // 获取并渲染历史列表
            async function fetchAndRenderHistory() {
                try {
                    const response = await fetch('/api/history');
                    const histories = await response.json();
                    historyList.innerHTML = '';
                    histories.forEach(h => {
                        const li = document.createElement('li');
                        li.textContent = h.title;
                        li.title = h.title // 鼠标悬停时显示完整内容
                        li.dataset.chatId = h.chatId;
                        li.addEventListener('click', () => loadChatHistory(h.chatId));
                        historyList.appendChild(li);
                    });
                } catch (error) {
                    console.error('Error fetching history:', error);
                }
            }

            // 加载指定的聊天记录
            async function loadChatHistory(chatId) {
                if (!chatId) return;
                try {
                    const response = await fetch(`/api/history/${chatId}`);
                    const messages = await response.json();
                    renderChatHistory(messages);
                    generateUserMessageIndex();
                    currentChatId = chatId;
                } catch (error) {
                    console.error('Error loading chat history:', error);
                }
            }

            async function sendMessage() {
                const prompt = promptInput.value.trim();
                const modelSelect = document.getElementById('gemini-v'); // 1. 获取 select 元素
                const selectedModel = modelSelect.value; // 2. 获取当前选中的 value
                if (!prompt && !currentFile) return;
                // 禁用按钮
                sendBtn.disabled = true;
                renderMessage('user', prompt || `已发送文件: ${currentFile.name}`);
                generateUserMessageIndex();
                promptInput.value = '';
                filePreviewContainer.innerHTML = '';
                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('model', selectedModel); // 3. 将选中的模型名称添加到 formData 中
                if (currentChatId) {
                    formData.append('chatId', currentChatId);
                }
                if (currentFile) {
                    formData.append('file', currentFile);
                    currentFile = null;
                }
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.classList.add('message', 'gemini-message', 'loading');
                chatWindow.appendChild(aiMessageDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                let accumulatedText = '';
                try {
                    const response = await fetch('/api/chat', { method: 'POST', body: formData });
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error || 'Network response was not ok');
                    }
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });
                        const parts = buffer.split('\n\n');
                        buffer = parts.pop();
                        for (const part of parts) {
                            if (part.startsWith('data:')) {
                                const dataString = part.substring(5).trim();
                                try {
                                    const data = JSON.parse(dataString);
                                    if (data.error) throw new Error(data.error);
                                    if (!currentChatId && data.chatId) {
                                        currentChatId = data.chatId;
                                        fetchAndRenderHistory();
                                    }
                                    accumulatedText += data.reply;
                                    aiMessageDiv.innerHTML = marked.parse(accumulatedText);
                                    chatWindow.scrollTop = chatWindow.scrollHeight;
                                } catch (e) {
                                    console.error('Error parsing stream data:', e);
                                }
                            }
                        }
                    }
                    hljs.highlightAll();
                } catch (error) {
                    console.error('Error sending message:', error);
                    aiMessageDiv.innerHTML = marked.parse(`抱歉，出错了: ${error.message}`);
                } finally {
                    aiMessageDiv.classList.remove('loading');
                    sendBtn.disabled = false;
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            }


            // --- 事件监听 ---
            sendBtn.addEventListener('click', sendMessage);
            promptInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { // Shift+Enter 换行，Enter 发送
                    e.preventDefault();
                    sendMessage();
                }
            });

            newChatBtn.addEventListener('click', () => {
                currentChatId = null;
                currentFile = null;
                filePreviewContainer.innerHTML = '';
                renderChatHistory([]); // 清空并显示欢迎语
                generateUserMessageIndex();
            });

            fileInput.addEventListener('change', (e) => {
                currentFile = e.target.files[0];
                if (currentFile) {
                    filePreviewContainer.innerHTML = `<span>${currentFile.name}</span>`;
                }
            });

            // --- 初始化 ---
            async function initializeApp() {
                await fetchAndRenderHistory();
                try {
                    const response = await fetch('/api/chat/latest');
                    const latestChat = await response.json();
                    currentChatId = latestChat.chatId;
                    renderChatHistory(latestChat.messages); // 渲染最新对话
                } catch (error) {
                    console.error('Could not load latest chat:', error);
                    renderChatHistory([]); // 出错时显示新对话的欢迎语
                } finally {
                    generateUserMessageIndex();
                }
            }

            initializeApp();
        });

        function openlist() {
            document.getElementById('history-list').style.width = '300px';
        }
        function closelist() {
            document.getElementById('history-list').style.width = '0';
        }

        function generateUserMessageIndex() {
            // 1. 获取目标列表和所有用户消息的DOM元素
            const indexList = document.getElementById('list-123');
            const userMessages = document.querySelectorAll('#chat-window .message.user-message');

            // 2. 清空旧的列表，以防重复生成
            indexList.innerHTML = '';

            // 如果没有用户消息，就不用显示标题了
            if (userMessages.length === 0) {
                return;
            }

            // (可选) 为列表添加一个标题
            const listTitle = document.createElement('h4');

            indexList.appendChild(listTitle);
            // 3. 遍历每一条用户消息
            userMessages.forEach((messageDiv, index) => {
                // a. 为消息<div>赋予一个唯一的ID，以便我们能跳转到它
                const messageId = `user-msg-${index}`;
                messageDiv.id = messageId;

                // b. 获取消息文本内容，并做一个简单的截断，防止列表项太长
                let messageText = messageDiv.querySelector('p')?.textContent || messageDiv.textContent;
                messageText = messageText.trim();
                if (!messageText) return;
                const displayText = messageText.length > 25
                    ? messageText.substring(0, 22) + '...'
                    : messageText;
                // c. 创建列表项 <li>
                const listItem = document.createElement('li');
                listItem.textContent = displayText;
                listItem.title = messageText; // 鼠标悬停时显示完整内容
                // d. 添加点击事件监听器
                listItem.addEventListener('click', (event) => {
                    // 阻止事件冒泡, 防止触发父元素.container上的closelist()事件
                    // event.stopPropagation();

                    const targetMessage = document.getElementById(messageId);
                    if (targetMessage) {
                        // 使用 scrollIntoView 平滑滚动到目标位置
                        targetMessage.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                });
                indexList.appendChild(listItem);
            });
        }
        //缓存选择
        const modelSelect = document.getElementById('gemini-v');
        modelSelect.addEventListener('change', function () {
            localStorage.setItem('selectedModel', this.value);
        });
        const savedValue = localStorage.getItem('selectedModel');
        if (savedValue) {
            modelSelect.value = savedValue;
        }
    </script>
</body>

</html>