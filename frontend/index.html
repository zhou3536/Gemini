<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyGemini</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="md.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<style>
/* --- [å‰ç«¯æ”¹é€ ] --- æ·»åŠ å¼€å…³å’Œæœç´¢æŒ‡ç¤ºå™¨æ ·å¼ --- */
.switch-container {
    display: flex;
    align-items: center;
    margin-right: 10px;
    cursor: pointer;
    font-size: 14px;
    user-select: none;
}
.switch-container input {
    display: none;
}
.switch {
    position: relative;
    display: inline-block;
    width: 34px;
    height: 20px;
    background-color: #ccc;
    border-radius: 20px;
    transition: background-color 0.2s;
    margin-right: 6px;
}
.switch::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background-color: white;
    top: 2px;
    left: 2px;
    transition: left 0.2s;
}
.switch-container input:checked + .switch {
    background-color: #4CAF50;
}
.switch-container input:checked + .switch::after {
    left: 16px;
}

.searching-indicator {
    display: flex;
    align-items: center;
    font-style: italic;
    color: #888;
    padding: 5px 0 10px 0;
    font-size: 0.9em;
    border-bottom: 1px solid #eee;
    margin-bottom: 10px;
}
.searching-indicator::before {
    content: 'ğŸ”';
    margin-right: 8px;
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
/* --- [æ ·å¼ç»“æŸ] --- */
</style>

<body>
    <div class="nav">Gemini</div>
    <div class="container">
        <ul id="history-list" class="list-1" onclick="closelist()"></ul>
        <ul id="list-123" class="list-1"></ul>
        <main class="chat-area">
            <div id="chat-window" onclick="closelist()"></div>
            <div class="input-area">
                <textarea id="prompt-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="2" onclick="closelist()"></textarea>
                <input type="file" id="file-input" hidden>
                <div class="send-box">
                    <div id="file-preview-container"></div>
                    <div class="menu">
                        <button id="history-b" onclick="openlist()">å†å²</button>
                        <button id="new-chat-btn">+ æ–°å»º</button>
                        <select id="gemini-v" class="send-btn1">
                            <option value="gemini-2.0-flash">2.0-flash</option>
                            <option value="gemini-2.5-flash">2.5-flash</option>
                            <option value="gemini-1.5-pro-latest">2.5-pro</option> 
                        </select>
                        
                        <!-- --- [å‰ç«¯æ”¹é€ ] --- æ·»åŠ è”ç½‘æœç´¢å¼€å…³ --- -->
                        <label class="switch-container" title="å¯ç”¨/ç¦ç”¨è”ç½‘æœç´¢">
                            <span>æœç´¢</span>
                            <input type="checkbox" id="search-toggle">
                            <span class="switch"></span>
                            
                        </label>
                        <!-- --- [å¼€å…³ç»“æŸ] --- -->

                        <button id="send-btn" class="send-btn"></button>
                        <label for="file-input" class="send-btn" hidden>æ–‡ä»¶</label>
                    </div>
                </div>
            </div>
            <p style="text-align: center;padding-bottom: 3px;font-size: 13px;">å†…å®¹ç”±Google AIç”Ÿæˆ</p>
        </main>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const chatWindow = document.getElementById('chat-window');
        const promptInput = document.getElementById('prompt-input');
        const sendBtn = document.getElementById('send-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const historyList = document.getElementById('history-list');
        const fileInput = document.getElementById('file-input');
        const filePreviewContainer = document.getElementById('file-preview-container');
        // --- [å‰ç«¯æ”¹é€ ] --- è·å–å¼€å…³å…ƒç´ 
        const searchToggle = document.getElementById('search-toggle');

        let currentChatId = null;
        let currentFile = null;

        if (typeof marked !== 'undefined' && typeof hljs !== 'undefined') {
            marked.setOptions({
                highlight: function (code, lang) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language }).value;
                },
                langPrefix: 'hljs language-',
                gfm: true,
                breaks: true
            });
        }

        // ... (renderMessage, renderChatHistory, fetchAndRenderHistory, loadChatHistory å‡½æ•°ä¿æŒä¸å˜) ...
        function renderMessage(sender, text, targetDiv = null) {
                const messageDiv = targetDiv || document.createElement('div');
                if (!targetDiv) {
                    messageDiv.classList.add('message', `${sender}-message`);
                }
                if (sender === 'gemini' && typeof marked !== 'undefined') {
                    // --- [å‰ç«¯æ”¹é€ ] --- åœ¨æ¸²æŸ“Geminiæ¶ˆæ¯æ—¶å¤„ç†HTMLå†…å®¹
                    const contentDiv = document.createElement('div');
                    contentDiv.innerHTML = marked.parse(text);

                    // å¦‚æœmessageDivä¸­å·²ç»æœ‰æœç´¢æŒ‡ç¤ºå™¨ï¼Œåˆ™åªæ›¿æ¢å†…å®¹éƒ¨åˆ†
                    const indicator = messageDiv.querySelector('.searching-indicator');
                    if (indicator) {
                        // æ¸…ç©ºé™¤äº†æŒ‡ç¤ºå™¨ä¹‹å¤–çš„æ‰€æœ‰å†…å®¹
                        Array.from(messageDiv.childNodes).forEach(node => {
                            if (node !== indicator) {
                                messageDiv.removeChild(node);
                            }
                        });
                        messageDiv.appendChild(contentDiv);
                    } else {
                         messageDiv.innerHTML = ''; // æ¸…ç©º
                         messageDiv.appendChild(contentDiv);
                    }
                    // --- [æ”¹é€ ç»“æŸ] ---
                } else {
                    const p = document.createElement('p');
                    p.textContent = text;
                    messageDiv.innerHTML = '';
                    messageDiv.appendChild(p);
                }
                if (!targetDiv) {
                    chatWindow.appendChild(messageDiv);
                }
                chatWindow.scrollTop = chatWindow.scrollHeight;
                return messageDiv;
        }

        function renderChatHistory(messages) {
            chatWindow.innerHTML = '';
            if (!messages || messages.length === 0) {
                renderMessage('gemini', 'Hello! å¼€å§‹æ–°çš„å¯¹è¯ï¼'); // æ¬¢è¿è¯­
                return;
            }
            // --- [å‰ç«¯æ”¹é€ ] --- åœ¨æ¸²æŸ“å†å²è®°å½•æ—¶ï¼Œè·³è¿‡å·¥å…·ç›¸å…³çš„éƒ¨åˆ†
            messages.forEach(msg => {
                // åªæ¸²æŸ“ role ä¸º 'user' æˆ– 'model' çš„ 'text' éƒ¨åˆ†
                if ((msg.role === 'user' || msg.role === 'model') && msg.parts.some(p => p.text)) {
                    const text = msg.parts.find(p => p.text)?.text || '';
                     renderMessage(msg.role === 'user' ? 'user' : 'gemini', text);
                }
            });
            // --- [æ”¹é€ ç»“æŸ] ---
        }

        async function fetchAndRenderHistory() {
                try {
                    const response = await fetch('/api/history');
                    const histories = await response.json();
                    historyList.innerHTML = '';
                    histories.forEach(h => {
                        const li = document.createElement('li');
                        li.textContent = h.title;
                        li.title = h.title;
                        li.dataset.chatId = h.chatId;
                        li.addEventListener('click', () => loadChatHistory(h.chatId));
                        historyList.appendChild(li);
                    });
                } catch (error) {
                    console.error('Error fetching history:', error);
                }
            }
        
        async function loadChatHistory(chatId) {
            if (!chatId) return;
            try {
                const response = await fetch(`/api/history/${chatId}`);
                if (!response.ok) {
                    throw new Error(`Chat with ID ${chatId} not found.`);
                }
                const messages = await response.json();
                renderChatHistory(messages);
                generateUserMessageIndex();
                currentChatId = chatId;
                localStorage.setItem('currentActiveChatId', chatId);
            } catch (error) {
                console.error('Error loading chat history:', error);
                localStorage.removeItem('currentActiveChatId');
                newChatBtn.click();
            }
        }


        async function sendMessage() {
            const prompt = promptInput.value.trim();
            const modelSelect = document.getElementById('gemini-v');
            const selectedModel = modelSelect.value;
            // --- [å‰ç«¯æ”¹é€ ] --- è·å–æœç´¢å¼€å…³çŠ¶æ€
            const enableSearch = searchToggle.checked;

            if (!prompt && !currentFile) return;

            sendBtn.disabled = true;
            renderMessage('user', prompt || `å·²å‘é€æ–‡ä»¶: ${currentFile.name}`);
            generateUserMessageIndex();
            promptInput.value = '';
            filePreviewContainer.innerHTML = '';
            chatWindow.scrollTop = chatWindow.scrollHeight;

            const formData = new FormData();
            formData.append('prompt', prompt);
            formData.append('model', selectedModel);
            // --- [å‰ç«¯æ”¹é€ ] --- å°†æœç´¢çŠ¶æ€å‘é€åˆ°åç«¯
            formData.append('enableSearch', enableSearch);

            if (currentChatId) formData.append('chatId', currentChatId);
            if (currentFile) {
                formData.append('file', currentFile);
                currentFile = null;
            }

            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.classList.add('message', 'gemini-message', 'loading');
            chatWindow.appendChild(aiMessageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            let accumulatedText = '';

            try {
                const response = await fetch('/api/chat', { method: 'POST', body: formData });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Network response was not ok');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const parts = buffer.split('\n\n');
                    buffer = parts.pop();

                    for (const part of parts) {
                        if (part.startsWith('data:')) {
                            const dataString = part.substring(5).trim();
                            try {
                                const data = JSON.parse(dataString);
                                if (data.error) throw new Error(data.error);

                                const isAtBottom = chatWindow.scrollHeight - chatWindow.scrollTop - chatWindow.clientHeight <= 10;
                                
                                if (!currentChatId && data.chatId) {
                                    currentChatId = data.chatId;
                                    localStorage.setItem('currentActiveChatId', currentChatId);
                                    fetchAndRenderHistory();
                                }
                                
                                // --- [å‰ç«¯æ”¹é€ ] --- å¤„ç†åç«¯çŠ¶æ€æ›´æ–° ---
                                if (data.status === 'searching') {
                                    let indicator = aiMessageDiv.querySelector('.searching-indicator');
                                    if (!indicator) {
                                        indicator = document.createElement('div');
                                        indicator.className = 'searching-indicator';
                                        aiMessageDiv.prepend(indicator); // å°†æŒ‡ç¤ºå™¨æ”¾åœ¨æ¶ˆæ¯é¡¶éƒ¨
                                    }
                                    indicator.textContent = `æ­£åœ¨æœç´¢: "${data.query}"...`;
                                } else if (data.reply) {
                                    accumulatedText += data.reply;
                                    // ä½¿ç”¨ç°æœ‰çš„ renderMessage é€»è¾‘æ¥æ›´æ–°å†…å®¹ï¼Œå®ƒä¼šä¿ç•™æŒ‡ç¤ºå™¨
                                    renderMessage('gemini', accumulatedText, aiMessageDiv);
                                }
                                // --- [æ”¹é€ ç»“æŸ] ---

                                if (isAtBottom) chatWindow.scrollTop = chatWindow.scrollHeight;

                            } catch (e) { console.error('Error parsing stream data:', e); }
                        }
                    }
                }
                hljs.highlightAll();
            } catch (error) {
                console.error('Error sending message:', error);
                aiMessageDiv.innerHTML = marked.parse(`æŠ±æ­‰ï¼Œå‡ºé”™äº†: ${error.message}`);
            } finally {
                aiMessageDiv.classList.remove('loading');
                sendBtn.disabled = false;
                const isAtBottom = chatWindow.scrollHeight - chatWindow.scrollTop - chatWindow.clientHeight <= 10;
                if (isAtBottom) chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }
    
        // ... (æ‰€æœ‰å…¶ä»–å‡½æ•°:äº‹ä»¶ç›‘å¬ã€åˆå§‹åŒ–ç­‰ä¿æŒä¸å˜)
        sendBtn.addEventListener('click', sendMessage);
        promptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        newChatBtn.addEventListener('click', () => {
            localStorage.removeItem('currentActiveChatId');
            currentChatId = null;
            currentFile = null;
            filePreviewContainer.innerHTML = '';
            renderChatHistory([]); 
            generateUserMessageIndex();
        });

        fileInput.addEventListener('change', (e) => {
            currentFile = e.target.files[0];
            if (currentFile) {
                filePreviewContainer.innerHTML = `<span>${currentFile.name}</span>`;
            }
        });

        async function initializeApp() {
            await fetchAndRenderHistory();
            const cachedChatId = localStorage.getItem('currentActiveChatId');
            if (cachedChatId) {
                await loadChatHistory(cachedChatId);
            } else {
                renderChatHistory([]);
                generateUserMessageIndex();
            }
        }

        initializeApp();
    });

    // --- ä»¥ä¸‹æ˜¯ä¸æ ¸å¿ƒé€»è¾‘æ— å…³çš„è¾…åŠ©å‡½æ•°ï¼Œä¿æŒä¸å˜ ---
    function openlist() { document.getElementById('history-list').style.width = '300px'; }
    function closelist() { document.getElementById('history-list').style.width = '0'; }
    function generateUserMessageIndex() {
            const indexList = document.getElementById('list-123');
            const userMessages = document.querySelectorAll('#chat-window .message.user-message');
            indexList.innerHTML = '';
            if (userMessages.length === 0) {
                return;
            }
            const listTitle = document.createElement('h4');
            listTitle.textContent = 'å¯¹è¯å¯¼èˆª';
            indexList.appendChild(listTitle);
            userMessages.forEach((messageDiv, index) => {
                const messageId = `user-msg-${index}`;
                messageDiv.id = messageId;
                let messageText = messageDiv.querySelector('p')?.textContent || messageDiv.textContent;
                messageText = messageText.trim();
                if (!messageText) return;
                const displayText = messageText.length > 25 ? messageText.substring(0, 22) + '...' : messageText;
                const listItem = document.createElement('li');
                listItem.textContent = displayText;
                listItem.title = messageText;
                listItem.addEventListener('click', (event) => {
                    const targetMessage = document.getElementById(messageId);
                    if (targetMessage) {
                        targetMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
                indexList.appendChild(listItem);
            });
        }
    const modelSelect = document.getElementById('gemini-v');
        modelSelect.addEventListener('change', function () {
            localStorage.setItem('selectedModel', this.value);
        });
        const savedValue = localStorage.getItem('selectedModel');
        if (savedValue) {
            modelSelect.value = savedValue;
        }else {
            modelSelect.value = "gemini-1.5-pro-latest"; // é»˜è®¤ä½¿ç”¨1.5 pro
            localStorage.setItem('selectedModel', "gemini-1.5-pro-latest");
        }
        async function del(...indices) {
            try {
                await fetch('/api/history/delete-by-indices', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ indices: indices })
                });
            } catch (error) { console.error("åˆ é™¤è¯·æ±‚å¤±è´¥:", error); } 
            finally { location.reload(); }
        }
        function adjustRows() {
            var textarea = document.getElementById("prompt-input");
            var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) { textarea.rows = 1; } else { textarea.rows = 2; }
        }
        window.onload = adjustRows;
        window.onresize = adjustRows;
    </script>
</body>
</html>
