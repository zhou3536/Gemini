<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyGemini</title>
    <!-- <link rel="stylesheet" href="style.css"> -->
    <!-- <link rel="stylesheet" href="md.css"> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
</head>
<style>
    .nav {
        height: 60px;
        display: flex;
        align-items: center;
        padding: 0 15px;
        gap: 10px;
        background-color: rgb(73, 158, 255);
    }

    .nav h1 {
        background-color: #ffffff;
        padding: 0 12px;
        border-radius: 15px;
    }

    .nav h1 span:nth-child(1),
    .nav h1 span:nth-child(4) {
        color: #4285F4;
    }

    .nav h1 span:nth-child(2),
    .nav h1 span:nth-child(6) {
        color: #EA4335;
    }

    .nav h1 span:nth-child(3) {
        color: #FBBC05;
    }

    .nav h1 span:nth-child(5) {
        color: #34A853;
    }

    /* 省略了部分样式代码以保持简洁，您可以根据喜好自定义 */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        --hhh: calc(100vh - 60px);
        --hhh: calc(100dvh - 60px);
    }

    body {
        font-family: sans-serif;
        margin: 0;
        background-color: #f4f4f9;
        max-width: 100vw;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        margin: 0;

    }

    .container {
        /* display: flex; */
        height: var(--hhh);
        position: relative;
    }

    .sidebar {
        width: 0;
        background-color: #202123;
        color: white;
        padding: 1rem;
        display: flex;
        flex-direction: column;
    }

    .nav button {
        background-color: rgba(52, 53, 65, 0.2);
        color: white;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
        border: none;
        box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }

    #history-list {
        /* width: 240px; */
        height: var(--hhh);
        list-style: none;
        padding: 0;
        margin: 0;
        overflow-y: auto;
        transition: all 0.3s ease;
        position: absolute;
        z-index: 1000;
    }

    #history-list li {
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #history-list li:hover {
        background-color: #343541;
    }

    .chat-area {
        background-color: rgba(255, 255, 255, 0.5);
        width: 100vw;
        max-width: 800px;
        display: flex;
        flex-direction: column;
        position: absolute;
        left: 50%;
        top: 0;
        transform: translateX(-50%);
        height: var(--hhh);
        box-shadow: 0 0 2px rgba(0, 0, 0, 0.1);
    }

    #chat-window {
        flex-grow: 1;
        overflow-y: auto;
        max-width: 100%;

    }

    .message {
        padding: 8px 20px;
        padding-left: 48px;
        line-height: 1.2;
    }

    .message p {
        margin: 5px 0;
        word-break: break-all;
        line-height: 1.6;
    }

    .user-message {
        background-color: #f8feff;
        position: relative;
    }


    .gemini-message {
        background-color: transparent;
        position: relative;
    }

    .user-message::before,
    .gemini-message::before {
        content: "";
        display: block;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        /* background-color: green; */
        position: absolute;
        left: 5px;
        top: 8px;
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .user-message::before {
        background-image: url('mb.png');
    }

    .gemini-message::before {
        background-image: url('gmm.png');
    }

    /* AI回复内容的Markdown样式优化 */
    .gemini-message h1,
    .gemini-message h2,
    .gemini-message h3,
    .gemini-message h4,
    .gemini-message h5,
    .gemini-message h6 {
        color: #2c3e50;
        font-weight: 600;
        margin: 16px 0 8px 0;
        line-height: 1.4;
    }

    .gemini-message h1 {
        font-size: 1.6em;
        border-bottom: 2px solid #3498db;
        padding-bottom: 8px;
    }

    .gemini-message h2 {
        font-size: 1.4em;
        border-bottom: 1px solid #bdc3c7;
        padding-bottom: 6px;
    }

    .gemini-message h3 {
        font-size: 1.2em;
        color: #34495e;
    }

    .gemini-message p {
        /* margin: 12px 0; */
        line-height: 1.6;
        word-break: break-word;
        color: #2c3e50;
    }

    /* 代码块样式 */
    .gemini-message pre {
        background-color: #f8f9fa;
        border: 1px solid #e1e8ed;
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
        overflow-x: auto;
        font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.4;
        position: relative;
    }

    .gemini-message pre code {
        background: none;
        border: none;
        padding: 0;
        font-size: inherit;
        color: inherit;
    }

    /* 行内代码样式 */
    .gemini-message code {
        background-color: #f1f3f4;
        color: #d73a49;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
        font-size: 0.9em;
        border: 1px solid #e1e8ed;
    }

    /* 引用块样式 */
    .gemini-message blockquote {
        border-left: 4px solid #3498db;
        background-color: #f8f9fa;
        margin: 16px 0;
        padding: 12px 16px;
        border-radius: 0 8px 8px 0;
        color: #555;
        font-style: italic;
    }

    .gemini-message blockquote p {
        margin: 0;
    }

    /* 列表样式 */
    .gemini-message ul,
    .gemini-message ol {
        margin: 12px 0;
        padding-left: 24px;
    }

    .gemini-message li {
        margin: 6px 0;
        line-height: 1.6;
    }

    .gemini-message ul li {
        list-style-type: disc;
    }

    .gemini-message ol li {
        list-style-type: decimal;
    }

    /* 表格样式 */
    .gemini-message table {
        border-collapse: collapse;
        width: 100%;
        margin: 16px 0;
        background-color: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .gemini-message th,
    .gemini-message td {
        border: 1px solid #e1e8ed;
        padding: 12px;
        text-align: left;
    }

    .gemini-message th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #2c3e50;
    }

    .gemini-message tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    /* 链接样式 */
    .gemini-message a {
        color: #3498db;
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: all 0.3s ease;
    }

    .gemini-message a:hover {
        color: #2980b9;
        border-bottom-color: #2980b9;
    }

    /* 分割线样式 */
    .gemini-message hr {
        border: none;
        height: 2px;
        background: linear-gradient(to right, #3498db, #2ecc71);
        margin: 24px 0;
        border-radius: 1px;
    }

    /* 强调文本样式 */
    .gemini-message strong {
        color: #2c3e50;
        font-weight: 600;
    }

    .gemini-message em {
        color: #7f8c8d;
        font-style: italic;
    }

    /* 图片样式 */
    .gemini-message img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 16px 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* 数学公式样式（如果使用） */
    .gemini-message .math {
        background-color: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
        font-family: 'Times New Roman', serif;
    }

    /* 高亮代码的特殊样式调整 */
    .gemini-message .hljs {
        background: #f8f9fa !important;
        color: #2c3e50 !important;
    }

    .gemini-message .hljs-comment {
        color: #8e908c !important;
    }

    .gemini-message .hljs-keyword {
        color: #8959a8 !important;
    }

    .gemini-message .hljs-string {
        color: #718c00 !important;
    }

    .gemini-message .hljs-number {
        color: #f5871f !important;
    }

    .gemini-message .hljs-function {
        color: #4271ae !important;
    }

    .input-area {
        background-color: #fff;
        border-radius: 12px;
        display: flex;
        width: calc(100% - 14px);
        max-width: 600px;
        margin: 0 auto;
        margin-top: 6px;
        padding: 8px;
        border: 1px solid #ddd;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    #prompt-input {
        /* background-color: #ffffff9d; */
        flex-grow: 1;
        padding: 10px;
        outline: none;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        line-height: 18px;
        font-family: Arial, sans-serif;
        min-height: 24px;
        overflow-y: auto;
        resize: none;
    }

    .input-area:focus-within {
        box-shadow: 0 0 0 1px #1eacff;
    }

    .send-box {
        position: relative;
    }

    .send-btn {
        background-image: url('send.png');
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        width: 35px;
        height: 35px;
    }

    .send-btn img {
        display: block;
        width: 30px;
    }

    #file-preview-container {
        position: absolute;
        font-size: 12px;
        line-height: 14px;
        left: 0;
        top: -20px;
        color: #6888;
        white-space: nowrap;
        /* overflow: hidden; */
        /* text-overflow: ellipsis; */
        background-color: #eefeff;
        border: 1px solid #bbb;
        border-radius: 3px;
    }

    .file-label {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        display: grid;
        place-content: center;
    }

    .hidden {
        display: none;
    }

    .ai-8 {
        width: 35px;
        height: 35px;
        position: relative;
        border-radius: 50%;
        border: 4px solid #1eacff;
        background-color: #fff;
    }

    .ai-8::before {
        content: '';
        position: absolute;
        width: 17px;
        height: 3px;
        background-color: #1eacff;
        top: 50%;
        left: 50%;
        transform-origin: left center;
        animation: radar 0.8s infinite linear;
    }

    @keyframes radar {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* 滚动条 */
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;

    }

    ::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);

    }

    ::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.5);
    }
</style>

<body>
    <div class="nav">
        <h1><span>G</span><span>e</span><span>m</span><span>i</span><span>n</span><span>i</span></h1>
        <button id="new-chat-btn">新建对话</button>
        <button id="history-b" onclick="openlist()">历史对话</button>
    </div>
    <div class="container" onclick="closelist()">
        <ul id="history-list" class="sidebar"></ul>
        <main class="chat-area">
            <div id="chat-window"></div>
            <!-- <div id="loading-indicator" class="hidden"></div> -->
            <div class="input-area">
                <textarea id="prompt-input" placeholder="输入消息..." rows="3"></textarea>
                <input type="file" id="file-input" hidden>
                <div class="send-box">
                    <div id="file-preview-container"></div>
                    <div style="display: grid;gap: 5px;">
                        <button id="send-btn" class="send-btn">
                            <!-- <img src="sent.png" alt=""> -->
                            <div class="ai-8 hidden" id="loading-indicator" ></div>
                        </button>
                        <label for="file-input" class="send-btn" hidden>文件</label>

                    </div>
                </div>

            </div>
            <p style="text-align: center;padding-bottom: 3px;font-size: 13px;">内容由Google AI生成</p>
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM 元素
            const chatWindow = document.getElementById('chat-window');
            const promptInput = document.getElementById('prompt-input');
            const sendBtn = document.getElementById('send-btn');
            const newChatBtn = document.getElementById('new-chat-btn');
            const historyList = document.getElementById('history-list');
            const loadingIndicator = document.getElementById('loading-indicator');
            const fileInput = document.getElementById('file-input');
            const filePreviewContainer = document.getElementById('file-preview-container');

            // 应用状态
            let currentChatId = null;
            let currentFile = null;

            // --- 配置 marked.js 和 highlight.js ---
            if (typeof marked !== 'undefined' && typeof hljs !== 'undefined') {
                marked.setOptions({
                    // 这里的 highlight 函数告诉 marked 如何高亮代码
                    highlight: function (code, lang) {
                        // 检查语言是否在 highlight.js 中注册，否则使用纯文本
                        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                        return hljs.highlight(code, { language }).value;
                    },
                    // marked 生成的代码块的类前缀，以便 highlight.js 的 CSS 可以识别
                    langPrefix: 'hljs language-',
                    gfm: true, // 启用 GitHub Flavored Markdown (表格、任务列表等)
                    breaks: true // 允许 Markdown 中的换行符渲染为 <br>
                });
            }


            // --- 功能函数 ---

            // 渲染消息 (现在可以处理Markdown)
            function renderMessage(sender, text) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', `${sender}-message`);

                if (sender === 'gemini' && typeof marked !== 'undefined') {
                    // 如果是Gemini的消息，并且 marked.js 已加载，则解析Markdown
                    messageDiv.innerHTML = marked.parse(text);
                } else {
                    // 对于用户消息或 marked.js 未加载的情况，依然使用textContent
                    const p = document.createElement('p');
                    // 注意：textContent 会自动转义 HTML 字符，防止XSS攻击
                    // 如果用户输入中也包含需要解析的Markdown，这里也需要用 marked.parse，但通常不建议对用户输入直接使用 innerHTML
                    p.textContent = text;
                    messageDiv.appendChild(p);
                }

                chatWindow.appendChild(messageDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            // 渲染整个消息历史 (保持不变，因为 renderMessage 会处理Markdown)
            function renderChatHistory(messages) {
                chatWindow.innerHTML = '';
                if (!messages || messages.length === 0) {
                    renderMessage('gemini', '你好！新对话已开始。'); // 更改了欢迎语末尾的字符，防止误解
                    return;
                }
                messages.forEach(msg => {
                    const text = msg.parts.find(p => p.text)?.text || '';
                    // 确保渲染历史时也正确处理Gemini的Markdown
                    renderMessage(msg.role === 'user' ? 'user' : 'gemini', text);
                });
            }

            // ... (其他函数保持不变，例如 setLoading, fetchAndRenderHistory, loadChatHistory, sendMessage) ...

            // 设置加载状态
            function setLoading(isLoading) {
                sendBtn.disabled = isLoading;
                loadingIndicator.classList.toggle('hidden', !isLoading);
            }

            // 获取并渲染历史列表
            async function fetchAndRenderHistory() {
                try {
                    const response = await fetch('/api/history');
                    const histories = await response.json();
                    historyList.innerHTML = '';
                    histories.forEach(h => {
                        const li = document.createElement('li');
                        li.textContent = h.title;
                        li.dataset.chatId = h.chatId;
                        li.addEventListener('click', () => loadChatHistory(h.chatId));
                        historyList.appendChild(li);
                    });
                } catch (error) {
                    console.error('Error fetching history:', error);
                }
            }

            // 加载指定的聊天记录
            async function loadChatHistory(chatId) {
                if (!chatId) return;
                try {
                    const response = await fetch(`/api/history/${chatId}`);
                    const messages = await response.json();
                    renderChatHistory(messages);
                    currentChatId = chatId;
                } catch (error) {
                    console.error('Error loading chat history:', error);
                }
            }

            // 发送消息
            async function sendMessage() {
                const prompt = promptInput.value.trim();
                if (!prompt && !currentFile) return;

                setLoading(true);
                // 对于用户发送的消息，通常不需要进行Markdown解析，直接显示原文
                renderMessage('user', prompt || `已发送文件: ${currentFile.name}`);
                promptInput.value = '';
                filePreviewContainer.innerHTML = '';

                const formData = new FormData();
                formData.append('prompt', prompt);
                if (currentChatId) {
                    formData.append('chatId', currentChatId);
                }
                if (currentFile) {
                    formData.append('file', currentFile);
                    currentFile = null;
                }

                try {
                    const response = await fetch('/api/chat', { method: 'POST', body: formData });
                    if (!response.ok) throw new Error('Network response was not ok');

                    const data = await response.json();
                    // Gemini的回复里可能包含Markdown，由 renderMessage 处理
                    renderMessage('gemini', data.reply);

                    const chatJustCreated = !currentChatId;
                    currentChatId = data.chatId;

                    if (chatJustCreated) {
                        fetchAndRenderHistory();
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    renderMessage('gemini', '抱歉，出错了，请稍后再试。');
                } finally {
                    setLoading(false);
                }
            }

            // --- 事件监听 ---
            sendBtn.addEventListener('click', sendMessage);
            promptInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { // Shift+Enter 换行，Enter 发送
                    e.preventDefault();
                    sendMessage();
                }
            });

            newChatBtn.addEventListener('click', () => {
                currentChatId = null;
                currentFile = null;
                filePreviewContainer.innerHTML = '';
                renderChatHistory([]); // 清空并显示欢迎语
            });

            fileInput.addEventListener('change', (e) => {
                currentFile = e.target.files[0];
                if (currentFile) {
                    filePreviewContainer.innerHTML = `<span>${currentFile.name}</span>`;
                }
            });

            // --- 初始化 ---
            async function initializeApp() {
                await fetchAndRenderHistory();
                try {
                    const response = await fetch('/api/chat/latest');
                    const latestChat = await response.json();
                    currentChatId = latestChat.chatId;
                    renderChatHistory(latestChat.messages); // 渲染最新对话
                } catch (error) {
                    console.error('Could not load latest chat:', error);
                    renderChatHistory([]); // 出错时显示新对话的欢迎语
                }
            }

            initializeApp();
        });

        function openlist() {
            document.getElementById('history-list').style.width = '240px';
        }
        function closelist() {
            document.getElementById('history-list').style.width = '0';
        }
    </script>
</body>

</html>