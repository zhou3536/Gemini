<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyGemini</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="md.css">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<style></style>

<body>
    <div class="nav">Gemini

    </div>
    <div class="container">
        <ul id="history-list" class="list-1" onclick="closelist()"></ul>
        <ul id="list-123" class="list-1"></ul>
        <main class="chat-area">
            <div id="chat-window"></div>
            <div class="input-area">
                <textarea id="prompt-input" placeholder="输入消息..." rows="2"></textarea>
                <input type="file" id="file-input" hidden>
                <div class="send-box">
                    <div id="file-preview-container"></div>
                    <div class="menu">
                        <button id="history-b" onclick="openlist()">历史</button>
                        <button id="new-chat-btn">+ 新建</button>
                        <select id="gemini-v" class="send-btn1">
                            <option value="gemini-2.0-flash">2.0-flash</option>
                            <option value="gemini-2.5-flash">2.5-flash</option>
                            <option value="gemini-2.5-pro">2.5-pro</option>
                        </select>
                        <button id="send-btn" class="send-btn">
                            <!-- <img src="sent.png" alt=""> -->
                        </button>
                        <label for="file-input" class="send-btn" hidden>文件</label>

                    </div>
                </div>

            </div>
            <p style="text-align: center;padding-bottom: 3px;font-size: 13px;">内容由Google AI生成</p>
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM 元素
            const chatWindow = document.getElementById('chat-window');
            const promptInput = document.getElementById('prompt-input');
            const sendBtn = document.getElementById('send-btn');
            const newChatBtn = document.getElementById('new-chat-btn');
            const historyList = document.getElementById('history-list');
            const fileInput = document.getElementById('file-input');
            const filePreviewContainer = document.getElementById('file-preview-container');

            // 应用状态
            let currentChatId = null;
            let currentFile = null;

            // --- 配置 marked.js 和 highlight.js ---
            if (typeof marked !== 'undefined' && typeof hljs !== 'undefined') {
                marked.setOptions({
                    highlight: function (code, lang) {
                        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                        return hljs.highlight(code, { language }).value;
                    },
                    langPrefix: 'hljs language-',
                    gfm: true,
                    breaks: true
                });
            }

            function renderMessage(sender, text, targetDiv = null) {
                const messageDiv = targetDiv || document.createElement('div');
                if (!targetDiv) {
                    messageDiv.classList.add('message', `${sender}-message`);
                }
                if (sender === 'gemini' && typeof marked !== 'undefined') {
                    messageDiv.innerHTML = marked.parse(text);
                } else {
                    const p = document.createElement('p');
                    p.textContent = text;
                    messageDiv.innerHTML = '';
                    messageDiv.appendChild(p);
                }
                if (!targetDiv) {
                    chatWindow.appendChild(messageDiv);
                }
                chatWindow.scrollTop = chatWindow.scrollHeight;
                return messageDiv;
            }

            function renderChatHistory(messages) {
                chatWindow.innerHTML = '';
                if (!messages || messages.length === 0) {
                    renderMessage('gemini', 'Hello! How can I do for you?'); // 欢迎语
                    return;
                }
                messages.forEach(msg => {
                    const text = msg.parts.find(p => p.text)?.text || '';
                    renderMessage(msg.role === 'user' ? 'user' : 'gemini', text);
                });
            }

            async function fetchAndRenderHistory() {
                try {
                    const response = await fetch('/api/history');
                    const histories = await response.json();
                    historyList.innerHTML = '';
                    const listTitle = document.createElement('h4');
                    listTitle.textContent = '关闭列表';
                    historyList.appendChild(listTitle);
                    histories.forEach(h => {
                        const li = document.createElement('li');
                        li.textContent = h.title;
                        li.title = h.title;
                        li.dataset.chatId = h.chatId;
                        li.addEventListener('click', () => loadChatHistory(h.chatId));
                        historyList.appendChild(li);
                    });
                } catch (error) {
                    console.error('Error fetching history:', error);
                }
            }

            // 加载指定的聊天记录 (修改点 1: 加载时缓存ID)
            async function loadChatHistory(chatId) {
                if (!chatId) return;
                try {
                    const response = await fetch(`/api/history/${chatId}`);
                    // 如果因为缓存的ID在服务端已被删除而找不到，则应回退到新会话
                    if (!response.ok) {
                        throw new Error(`Chat with ID ${chatId} not found.`);
                    }
                    const messages = await response.json();
                    renderChatHistory(messages);
                    generateUserMessageIndex();
                    currentChatId = chatId;
                    // **关键修改：加载成功后，将当前对话ID存入 localStorage**
                    localStorage.setItem('currentActiveChatId', chatId);
                } catch (error) {
                    console.error('Error loading chat history:', error);
                    // **关键修改：如果加载失败（比如ID不存在了），清除缓存并打开新会话**
                    localStorage.removeItem('currentActiveChatId');
                    newChatBtn.click(); // 模拟点击新建对话按钮，重置界面
                }
            }

            async function sendMessage() {
                const prompt = promptInput.value.trim();
                const modelSelect = document.getElementById('gemini-v');
                const selectedModel = modelSelect.value;
                if (!prompt && !currentFile) return;

                sendBtn.disabled = true;
                renderMessage('user', prompt || `已发送文件: ${currentFile.name}`);
                generateUserMessageIndex();
                promptInput.value = '';
                filePreviewContainer.innerHTML = '';
                chatWindow.scrollTop = chatWindow.scrollHeight;
                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('model', selectedModel);
                if (currentChatId) {
                    formData.append('chatId', currentChatId);
                }
                if (currentFile) {
                    formData.append('file', currentFile);
                    currentFile = null;
                }
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.classList.add('message', 'gemini-message', 'loading');
                chatWindow.appendChild(aiMessageDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                let accumulatedText = '';
                try {
                    const response = await fetch('/api/chat', { method: 'POST', body: formData });
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error || 'Network response was not ok');
                    }
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });
                        const parts = buffer.split('\n\n');
                        buffer = parts.pop();
                        for (const part of parts) {
                            if (part.startsWith('data:')) {
                                const dataString = part.substring(5).trim();
                                try {
                                    const data = JSON.parse(dataString);
                                    if (data.error) throw new Error(data.error);

                                    // --- [关键修改：智能滚动逻辑] ---
                                    // 1. 在添加新内容之前，检查滚动条是否接近底部
                                    const threshold = 10;
                                    const isAtBottom = chatWindow.scrollHeight - chatWindow.scrollTop - chatWindow.clientHeight <= threshold;

                                    // 更新内容
                                    if (!currentChatId && data.chatId) {
                                        currentChatId = data.chatId;
                                        localStorage.setItem('currentActiveChatId', currentChatId);
                                        fetchAndRenderHistory();
                                    }
                                    accumulatedText += data.reply;
                                    aiMessageDiv.innerHTML = marked.parse(accumulatedText);

                                    // 2. 如果之前就在底部，那么在添加新内容后，自动滚动到底部
                                    if (isAtBottom) {
                                        chatWindow.scrollTop = chatWindow.scrollHeight;
                                    }
                                    // ------------------------------------

                                } catch (e) {
                                    console.error('Error parsing stream data:', e);
                                }
                            }
                        }
                    }
                    hljs.highlightAll();
                } catch (error) {
                    console.error('Error sending message:', error);
                    aiMessageDiv.innerHTML = marked.parse(`抱歉，出错了: ${error.message}`);
                } finally {
                    aiMessageDiv.classList.remove('loading');
                    sendBtn.disabled = false;

                    // [修改点 3] 在所有操作结束后，最后再执行一次智能滚动判断
                    const threshold = 10;
                    const isAtBottom = chatWindow.scrollHeight - chatWindow.scrollTop - chatWindow.clientHeight <= threshold;
                    if (isAtBottom) {
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                    }
                }
            }



            // --- 事件监听 ---
            sendBtn.addEventListener('click', sendMessage);
            promptInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // (修改点 3: 新建对话时清除缓存)
            newChatBtn.addEventListener('click', () => {
                // **关键修改：清除 localStorage 中的对话ID**
                localStorage.removeItem('currentActiveChatId');

                currentChatId = null;
                currentFile = null;
                filePreviewContainer.innerHTML = '';
                renderChatHistory([]); // 清空并显示欢迎语
                generateUserMessageIndex();
            });

            fileInput.addEventListener('change', (e) => {
                currentFile = e.target.files[0];
                if (currentFile) {
                    filePreviewContainer.innerHTML = `<span>${currentFile.name}</span>`;
                }
            });

            // --- 初始化 (修改点 4: 重写初始化逻辑) ---
            async function initializeApp() {
                // 1. 总是获取并渲染历史列表
                await fetchAndRenderHistory();

                // 2. 检查localStorage中是否有缓存的对话ID
                const cachedChatId = localStorage.getItem('currentActiveChatId');

                if (cachedChatId) {
                    // 如果有，就加载这个对话
                    console.log(`Found cached chat ID: ${cachedChatId}. Loading...`);
                    await loadChatHistory(cachedChatId);
                } else {
                    // 如果没有，就打开一个新会话
                    console.log('No cached chat ID found. Starting a new session.');
                    renderChatHistory([]); // 清空并显示欢迎语
                    generateUserMessageIndex();
                }
            }

            initializeApp();
        });

        // --- 以下是与核心逻辑无关的辅助函数，保持不变 ---

        function openlist() {
            document.getElementById('history-list').style.width = '300px';
        }
        function closelist() {
            document.getElementById('history-list').style.width = '0';
        }

        function generateUserMessageIndex() {
            const indexList = document.getElementById('list-123');
            const userMessages = document.querySelectorAll('#chat-window .message.user-message');
            indexList.innerHTML = '';
            if (userMessages.length === 0) {
                return;
            }
            const listTitle = document.createElement('h4');
            listTitle.textContent = '对话导航';
            indexList.appendChild(listTitle);
            userMessages.forEach((messageDiv, index) => {
                const messageId = `user-msg-${index}`;
                messageDiv.id = messageId;
                let messageText = messageDiv.querySelector('p')?.textContent || messageDiv.textContent;
                messageText = messageText.trim();
                if (!messageText) return;
                const displayText = messageText.length > 25 ? messageText.substring(0, 22) + '...' : messageText;
                const listItem = document.createElement('li');
                listItem.textContent = displayText;
                listItem.title = messageText;
                listItem.addEventListener('click', (event) => {
                    const targetMessage = document.getElementById(messageId);
                    if (targetMessage) {
                        targetMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
                indexList.appendChild(listItem);
            });
        }
        //缓存选择
        const modelSelect = document.getElementById('gemini-v');
        modelSelect.addEventListener('change', function () {
            localStorage.setItem('selectedModel', this.value);
        });
        const savedValue = localStorage.getItem('selectedModel');
        if (savedValue) {
            modelSelect.value = savedValue;
        }



        async function del(...indices) {
            try {
                await fetch('/api/history/delete-by-indices', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ indices: indices })
                });
            } catch (error) {
                console.error("删除请求失败:", error);
            } finally {
                location.reload();
            }
        }
        //改变输入框行数
        function adjustRows() {
            var textarea = document.getElementById("prompt-input");
            var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) { textarea.rows = 1; } else { textarea.rows = 2; }
        }
        window.onload = adjustRows;
        window.onresize = adjustRows;
    </script>
</body>

</html>